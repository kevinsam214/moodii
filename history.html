<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¿ƒæƒ…æ­·å²ç´€éŒ„ - Moodii å¿ƒèªæ—¥è¨˜</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet" />
</head>

<body>
  <div class="container">
    <h1 class="main-title">ğŸ•°ï¸ å¿ƒæƒ…æ­·å²ç´€éŒ„</h1>
    <p class="hint-text">çœ‹çœ‹æœ€è¿‘çš„ä½ ï¼Œæ˜¯ä»€éº¼æ¨£çš„æƒ…ç·’çµ„æˆçš„ ğŸ’›</p>
    <div id="history-list" class="history-list"></div>

    <div class="nav-group">
      <button class="secondary-btn" onclick="window.location.href='chart.html'">ğŸ“Š æŸ¥çœ‹çµ±è¨ˆåœ–</button>    
      <button class="main-btn" onclick="window.location.href='index.html'">å›é¦–é </button>
    </div>
    <div class="export-group">
      <button class="secondary-btn" onclick="exportJSON()">ğŸ“¦ ä¸‹è¼‰ JSON</button>
      <button class="secondary-btn" onclick="exportCSV()">ğŸ“„ ä¸‹è¼‰ CSV</button>
    </div>
    <div class="import-group">
      <label class="secondary-btn">
        ğŸ“¤ åŒ¯å…¥ JSON
        <input type="file" id="importInput" accept=".json" hidden />
      </label>
    </div>
    
    <div class="danger-group">
      <button class="danger-btn" onclick="clearAllRecords()">âš ï¸ æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
    </div>
  </div>

  <script>
    const moodIcons = {
      happy: "ğŸ˜Š",
      neutral: "ğŸ˜",
      sad: "ğŸ˜¢",
      tired: "ğŸ˜–",
      angry: "ğŸ˜¡"
    };

    const moodColors = {
        happy: "#FFF5C0",
        neutral: "#EEEEEE",
        sad: "#D6E9FF",
        tired: "#EAD9F2",
        angry: "#FFC7B2"
      };

      const specialHighlight = "#FFF8D5"; // starred å°ˆç”¨è‰²

    const history = JSON.parse(localStorage.getItem("moodHistory")) || [];
    const sorted = history.sort((a, b) => b.date.localeCompare(a.date)).slice(0, 7);
    const list = document.getElementById("history-list");

    if (sorted.length === 0) {
      list.innerHTML = "<p>ç›®å‰æ²’æœ‰ç´€éŒ„å–”ï¼Œå¿«å»å¯«ä¸‹ä»Šå¤©çš„å¿ƒæƒ…å§ï¼</p>";
    } else {
      sorted.forEach((item, index) => {
        const box = document.createElement("div");
        box.className = "history-item";
        box.style.backgroundColor = item.starred
          ? specialHighlight
          : (moodColors[item.mood] || "#EEE");

        const isStarred = item.starred === true;

        box.innerHTML = `
  <div class="history-date">${item.date}</div>
<img src="images/${isStarred ? 'star-filled.png' : 'star-empty.png'}"
     class="star-icon corner-top-right"
     data-date="${item.date}"
     title="${isStarred ? 'å·²æ¨™è¨»ç‚ºç‰¹åˆ¥çš„ä¸€å¤©' : 'é»æˆ‘æ¨™è¨»ç‚ºç‰¹åˆ¥çš„ä¸€å¤©'}" />

<button class="delete-btn corner-bottom-right" data-date="${item.date}" title="åˆªé™¤">ğŸ—‘ï¸</button>

  </div>
  <div class="history-mood">${moodIcons[item.mood] || "ğŸŒˆ"}</div>
  <div class="history-text">${item.text || "ï¼ˆæ²’æœ‰å¯«å…§å®¹ï¼‰"}</div>
`;




        list.appendChild(box);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const date = btn.getAttribute('data-date');
          if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
            const allRecords = JSON.parse(localStorage.getItem("moodHistory")) || [];
            const updated = allRecords.filter(item => item.date !== date);

            localStorage.setItem("moodHistory", JSON.stringify(updated));
            location.reload(); // âœ… é‡æ–°è¼‰å…¥ç•«é¢
          }
        });
      });

      document.querySelectorAll('.star-icon').forEach(img => {
        img.addEventListener('click', () => {
          const date = img.getAttribute('data-date');
          const allRecords = JSON.parse(localStorage.getItem("moodHistory")) || [];

          const updated = allRecords.map(item => {
            if (item.date === date) {
              return { ...item, starred: !item.starred };
            } else {
              return item;
            }
          });

          localStorage.setItem("moodHistory", JSON.stringify(updated));
          location.reload();
        });
      });




    }

    function exportJSON() {
        const data = localStorage.getItem("moodHistory") || "[]";
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        downloadFile(url, "mood-history.json");
      }

      function exportCSV() {
        const raw = JSON.parse(localStorage.getItem("moodHistory")) || [];
        if (raw.length === 0) {
          alert("ç›®å‰æ²’æœ‰ç´€éŒ„å¯åŒ¯å‡ºï¼");
          return;
        }

        const header = ["æ—¥æœŸ", "æƒ…ç·’", "æ–‡å­—", "æ˜¯å¦æ¨™è¨»"];
        const rows = raw.map(item => [
          item.date,
          item.mood,
          `"${(item.text || "").replace(/"/g, '""')}"`, // è™•ç†å¼•è™Ÿ
          item.starred ? "â­" : ""
        ]);

        const csvContent =
          [header, ...rows]
            .map(row => row.join(","))
            .join("\n");

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        downloadFile(url, "mood-history.csv");
      }

      function downloadFile(url, filename) {
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        link.click();
        URL.revokeObjectURL(url);
      }

      function clearAllRecords() {
          const confirmClear = confirm("ä½ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿé€™å€‹å‹•ä½œç„¡æ³•å¾©åŸï¼");
          if (confirmClear) {
            localStorage.removeItem("moodHistory");
            alert("æ‰€æœ‰ç´€éŒ„å·²æ¸…é™¤ï¼");
            location.reload();
          }
        }

        document.getElementById("importInput").addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const data = JSON.parse(e.target.result);
                if (!Array.isArray(data)) throw new Error("æ ¼å¼éŒ¯èª¤");

                const valid = data.every(item => item.date && item.mood);
                if (!valid) throw new Error("ç¼ºå°‘å¿…è¦æ¬„ä½");

                localStorage.setItem("moodHistory", JSON.stringify(data));
                alert("åŒ¯å…¥æˆåŠŸï¼ç•«é¢å°‡é‡æ–°è¼‰å…¥");
                location.reload();
              } catch (err) {
                alert("âŒ åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º");
                console.error(err);
              }
            };
            reader.readAsText(file);
          });

  </script>
</body>

</html>